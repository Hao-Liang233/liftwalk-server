<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
    </head>
    <body>
        <form method="post" action="/">
            <input  name="send" type="submit" value="設備控制">
            <input  name="send" type="submit" value="參數設定">
            <input  name="send" type="submit" value="手動控制">
        </form>
        <form action="/control" id="control_form" method="post">
            <label>設備選擇</label>
            <select name="sel_device" id="sel_device">
                <option value = ""></option>
                <% for(var i=0; i< device_list.length; i++){ %>
                    <option value = "<%- device_list[i] %>"><%- device_list[i] %></option>
                <% } %>
            </select>
            <br>
            <label>參數選擇</label>
            <select name="sel_setfile" id="sel_setfile">
                <option value = ""></option>
                <% for(var i=0; i< setfile_list.length; i++){ %>
                    <option value = "<%- setfile_list[i] %>"><%- setfile_list[i] %></option>
                <% } %>
            </select>
            <br>
            <label>目前參數：</label>
            <% for(var key in show_data){ %>
                <p>
                    <label><%- key %></label>
                    <input type="text" id="<%- key %>" name="<%- key %>" value="<%= show_data[key] %>" readonly  unselectable="on">
                </p>
            <% } %>
            <p>
                <label>目前設備</label>
                <label id="now_device"></label>
            </p>
            <input type="submit" id="start_up" value="開始運作" name="send">
        </form>

    </body>
    <script>
        var max_hight=0;
        $("#sel_device").change(function(){
            if($(this).val() == "") return;
            $.ajax({
                url:"/get_Device_data",
                method:"post",
                dataType:"json",
                data:{"mac" : $(this).val()},
                success:function(res){
                    //console.log(res)
                    for(var key in res){
                        //console.log(key);
                        $("#"+key).val(res[key]);
                    }
                    max_hight=res["max_hight"];
                },
                error:function(err){console.log(err)},
            });
        })
        $("#sel_setfile").change(function(){
            if($(this).val() == "") return;
            $.ajax({
                url:"/get_setfile_data",
                method:"post",
                dataType:"json",
                data:{"name" : $(this).val()},
                success:function(res){
                    //console.log(res)
                    for(var key in res){
                        //console.log(key);
                        $("#"+key).val(res[key]);
                    }
                },
                error:function(err){console.log(err)},
            });
        })

        $("#sel_device").change(function(){
            $("#now_device").text($(this).val());
        });

        $("#start_up").click(function(){
            var str="";
            let data = {};
            let value = $('#control_form').serializeArray();
            $.each(value, function (index, item) {
              data[item.name] = item.value;
            });
            //let json = JSON.stringify(data);
            if(data["sel_device"] == "") str="請選擇設備";
            else if(data["step1_Hight"]+data["step2_Hight"]+data["step3_Hight"] > max_hight) str="操作高度超過該設備的高度";
            if(str != ""){
                alert(str);
                return false;
            }
            return true;
        })
    </script>
</html>